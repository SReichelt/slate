# Slate development

This document describes how to build and run Slate locally, and how to deploy it to Heroku.

## Building Slate

1. Install the following software:
   * [Git](https://git-scm.com/downloads)
   * Microsoft [Visual Studio Code](https://code.visualstudio.com/Download)
   * [Node.js](https://nodejs.org/)
   * Google [Chrome](https://www.google.com/chrome/) or [Chromium](https://www.chromium.org/Home)
   * [React Developer Tools](https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi)
2. Make sure the programs `git`, `code`, and `npm` can be started from the command line, i.e. are accessible via the `PATH` environment variable.
3. In a terminal, in a directory of your choice, run
   ```
   git clone --recursive https://github.com/SReichelt/slate.git
   cd slate
   npm install
   npm run build
   ```

Rerun `npm install` and `npm run build` after a pulling a new version from the repository.

## Running Slate locally

1. First build Slate as described above. (However, the output of `npm run build` will not be used when running locally, so that step can be skipped.)
2. Create a script `chrome-remote-debug` as follows, in a directory that is referenced by the `PATH` environment variable:
   * On Linux, create a text file `chrome-remote-debug` with the contents
     ```
     #! /bin/sh
     set -e
     /usr/bin/google-chrome --remote-debugging-port=9222 "$@"
     ```
     and make it executable via `chmod +x`.
   * On Windows, create a text file `chrome-remote-debug.cmd` with the contents
     ```
     "<path>\chrome.exe" --remote-debugging-port=9222 %*
     ```
     replacing `<path>` with the correct path.
3. Start Visual Studio Code, and open the workspace `Slate.code-workspace`.
4. Now you should be able to execute the app via "Run / Start debugging" (F5). If successful, a browser will open.
5. If the app does not start, check all output/console/terminal windows of Visual Studio Code for errors.
6. _Optional:_ If you would like to debug the application, select the launch configuration called "Launch and attach", which attaches the VSCode debugger to Chrome.
7. _Optional:_ To debug GitHub support, set up an OAuth application at https://github.com/settings/developers.
   * Enter http://localhost:3000/ for the callback URL.
   * After creating the application, add environment variables `GITHUB_CLIENT_ID` and `GITHUB_CLIENT_SECRET` to your local machine, according to the values reported by GitHub.

## Running the VSCode extension

1. First build Slate as described above. (Note that in contrast to the first item under "Running Slate locally", the embedded webview of the VSCode extension will actually use the output of `npm run build`.)
2. Open the separate workspace `Slate-vscode.code-workspace`.
3. Click "Run / Start debugging" (F5).

## Installing the locally built VSCode extension

When developing Slate, you will probably want to install the locally built version of the VSCode extension instead of the published version.

1. First build Slate as described above.
2. Open a terminal in the [VSCode extensions folder](https://vscode-docs.readthedocs.io/en/stable/extensions/install-extension/#your-extensions-folder).
3. Create a symbolic link to the `src/vscode` subdirectory of Slate:
   * On Linux, use
     ```
     ln -s <path>/src/vscode slate
     ```
   * On Windows, use `mklink` with the `/d` option, or `New-Item` in PowerShell.

## Deploying to Heroku

Creating a new public installation of Slate is very simple, and should work out of the box on Heroku:

1. Create an account at https://www.heroku.com/.
2. Create a new Node.js app.
3. Either configure the app to track your GitHub repository, or add Heroku as a Git remote and push to it (see https://devcenter.heroku.com/articles/git).
4. This should be sufficient to create a read-only installation of Slate. Verify that the Heroku build was successful and that the website can be viewed.
5. To allow users to submit modifications, some "Config Vars" need to be set up in the app settings on Heroku. For anonymous contributions, add the following variables:
   * `MAIL_HOST`: Hostname of an SMTP provider of your choice.
   * `MAIL_USER`, `MAIL_PASSWORD`: Login for the SMTP provider.
   * `MAIL_FROM`, `MAIL_TO`: Email headers for submission mails.
6. To let users submit GitHub pull requests, you need to set up your OAuth application at https://github.com/settings/developers. For the callback URL, enter the Heroku URL of the app. Then add the following two config vars in Heroku:
   * `GITHUB_CLIENT_ID`: The client ID generated by GitHub.
   * `GITHUB_CLIENT_SECRET`: The GitHub secret generated by GitHub.

Unless configured differently, the new installation behave like the official installation in that it will load library data from https://github.com/SReichelt/slate-hlm.git and also submit pull requests to that repository. Currently, the easiest way to set up a custom library would be to edit `data/libraries/libraries.json`.
